name: Check Virtualization Support

# 定义触发方式
on:
  workflow_dispatch: # 手动触发

jobs:
  check-virtualization:
    runs-on: windows-11-arm # 使用 Windows ARM64 运行器
    steps:
      - name: Check System Info
        run: systeminfo
        shell: cmd

      - name: Check Virtualization with PowerShell
        shell: pwsh
        run: |
          Get-ComputerInfo | Select-Object -Property WindowsProductName, HyperVisorPresent
          Get-CimInstance -ClassName Win32_Processor | Select-Object -Property VirtualizationFirmwareEnabled, VMMonitorModeExtensions
          Get-WindowsOptionalFeature -Online | Where-Object { $_.FeatureName -like "*Hyper-V*" }

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21' # 使用 Java 21
          java-package: 'jdk'
          check-latest: false
          server-id: 'github'
          server-username: ${{ github.actor }}
          server-password: ${{ github.token }}
          overwrite-settings: true

      - name: Verify Java Installation
        run: java -version
        shell: pwsh
      - name: Install Android SDK Components
        run: |
          $env:ANDROID_HOME = "C:/Android/android-sdk"
          mkdir $env:ANDROID_HOME -ErrorAction SilentlyContinue
          # 下载 platform-tools
          curl -L -o platform-tools.zip https://dl.google.com/android/repository/platform-tools-latest-windows.zip
          if (Test-Path platform-tools.zip) { Write-Output "Platform tools downloaded"; } else { Write-Error "Platform tools download failed"; exit 1 }
          unzip platform-tools.zip -d $env:ANDROID_HOME
          # 下载系统镜像
          curl -L -o system-image.zip https://dl.google.com/android/repository/sys-img/google_apis/arm64-v8a-34_r04.zip
          if (Test-Path system-image.zip) { Write-Output "System image downloaded"; } else { Write-Error "System image download failed"; exit 1 }
          mkdir $env:ANDROID_HOME/system-images/android-34/google_apis/arm64-v8a -ErrorAction SilentlyContinue
          unzip system-image.zip -d $env:ANDROID_HOME/system-images/android-34/google_apis/arm64-v8a
          # 下载 emulator
          curl -L -o emulator.zip https://dl.google.com/android/repository/emulator-windows_arm64-35.3.12.zip
          if (Test-Path emulator.zip) { Write-Output "Emulator downloaded"; } else { Write-Error "Emulator download failed"; exit 1 }
          unzip emulator.zip -d $env:ANDROID_HOME/emulator
          # 设置 PATH
          $env:PATH = "$env:ANDROID_HOME/platform-tools;$env:ANDROID_HOME/emulator;$env:PATH"
          # 验证
          adb version
          emulator -version
        shell: pwsh
      
      - name: Create AVD
        run: |
          # 下载命令行工具（更新到最新版本）
          curl -L -o cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-win-13580629_latest.zip
          if (Test-Path cmdline-tools.zip) { Write-Output "Cmdline tools downloaded"; } else { Write-Error "Cmdline tools download failed"; exit 1 }
          unzip cmdline-tools.zip -d $env:ANDROID_HOME/cmdline-tools
          # 列出可用设备以便调试
          & "$env:ANDROID_HOME/cmdline-tools/cmdline-tools/bin/avdmanager.bat" list device
          # 检查系统镜像目录
          dir $env:ANDROID_HOME/system-images/android-34/google_apis/arm64-v8a
          # 创建 AVD，指定设备
          echo no | & "$env:ANDROID_HOME/cmdline-tools/cmdline-tools/bin/avdmanager.bat" create avd -n test-avd -k "system-images;android-34;google_apis;arm64-v8a" -d pixel_6 --force
          # 验证 AVD 创建
          dir $env:ANDROID_AVD_HOME/test-avd.avd
        shell: pwsh
        env:
          ANDROID_HOME: C:/Android/android-sdk
          ANDROID_AVD_HOME: C:/Android/.android/avd
      - name: Start Emulator
        run: |
          $env:ANDROID_HOME\emulator\emulator -avd test-avd -no-window -no-audio
        shell: pwsh
        env:
          ANDROID_HOME: C:\Android\android-sdk
          ANDROID_AVD_HOME: C:\Android\.android\avd
